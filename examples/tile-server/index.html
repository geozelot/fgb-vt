<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>fgb-vt test map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css"
  />
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #map { position: absolute; inset: 0; }

    #controls {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1;
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.18);
      font-size: 13px;
      line-height: 1;
    }
    #controls h3 {
      margin: 0 0 8px;
      font-size: 12px;
      font-weight: 600;
      color: #999;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    #controls h3:not(:first-child) {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    #controls label {
      display: flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      padding: 5px 0;
      color: #444;
    }
    #controls label:hover { color: #000; }
    #controls input[type="radio"] { margin: 0; accent-color: #4264fb; }
    .tag {
      font-size: 10px;
      font-weight: 600;
      padding: 1px 5px;
      border-radius: 3px;
      letter-spacing: .03em;
    }
    .tag-server  { background: #dbeafe; color: #1d4ed8; }
    .tag-client  { background: #dcfce7; color: #15803d; }
    .tag-fn      { background: #fef3c7; color: #b45309; }
    .tag-local   { background: #f1f5f9; color: #475569; }
    .tag-http    { background: #f3e8ff; color: #7c3aed; }
    .tag-s3      { background: #fef2f2; color: #dc2626; }

    #timing {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #eee;
      font-size: 11px;
      color: #888;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="controls">
    <h3>Connector</h3>
    <label>
      <input type="radio" name="dataset" value="us_counties_local" checked />
      US Counties
      <span class="tag tag-local">local</span>
    </label>
    <label>
      <input type="radio" name="dataset" value="us_counties_http" />
      US Counties
      <span class="tag tag-http">http</span>
    </label>
    <label>
      <input type="radio" name="dataset" value="us_counties_s3" />
      US Counties
      <span class="tag tag-s3">s3</span>
    </label>

    <h3>API Tier</h3>
    <label>
      <input type="radio" name="tier" value="server" checked />
      TileServer
      <span class="tag tag-server">stateful</span>
    </label>
    <label>
      <input type="radio" name="tier" value="client" />
      TileClient
      <span class="tag tag-client">semi-stateful</span>
    </label>
    <label>
      <input type="radio" name="tier" value="fn" />
      tile()
      <span class="tag tag-fn">stateless</span>
    </label>

    <div id="timing"></div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script>
    const TIERS    = ['server', 'client', 'fn'];
    const DATASETS = ['us_counties_local', 'us_counties_http', 'us_counties_s3'];
    const LAYER    = 'us_counties';

    const TIER_COLORS = {
      server: { fill: '#4264fb', line: '#1d4ed8' },
      client: { fill: '#22c55e', line: '#15803d' },
      fn:     { fill: '#f59e0b', line: '#b45309' },
    };

    function tileUrl(dataset, tier) {
      return `${location.origin}/tiles/${dataset}/${tier}/{z}/{x}/{y}.pbf`;
    }

    // ── Build style with all 6 sources, 12 layers ──
    function buildStyle(activeDataset, activeTier) {
      const sources = {
        'osm-raster': {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
          tileSize: 256,
          attribution: '&copy; OpenStreetMap contributors',
        },
      };

      const layers = [{ id: 'osm-basemap', type: 'raster', source: 'osm-raster' }];

      for (const d of DATASETS) {
        for (const t of TIERS) {
          const srcId = `fgb-${d}-${t}`;
          sources[srcId] = {
            type: 'vector',
            tiles: [tileUrl(d, t)],
            minzoom: 0,
            maxzoom: 14,
          };

          const vis = (d === activeDataset && t === activeTier) ? 'visible' : 'none';
          const colors = TIER_COLORS[t];

          layers.push({
            id: `fill-${d}-${t}`,
            type: 'fill',
            source: srcId,
            'source-layer': LAYER,
            layout: { visibility: vis },
            paint: { 'fill-color': colors.fill, 'fill-opacity': 0.25 },
          });
          layers.push({
            id: `line-${d}-${t}`,
            type: 'line',
            source: srcId,
            'source-layer': LAYER,
            layout: { visibility: vis },
            paint: { 'line-color': colors.line, 'line-width': 0.8 },
          });
        }
      }

      return { version: 8, sources, layers };
    }

    // ── State ──
    let activeDataset = 'us_counties_local';
    let activeTier    = 'server';

    // ── Map ──
    const map = new maplibregl.Map({
      container: 'map',
      style: buildStyle(activeDataset, activeTier),
      center: [-98.5, 39.8],
      zoom: 4,
    });

    // ── Tile load timing ──
    const timingEl = document.getElementById('timing');
    let loadStart = null;

    map.on('dataloading', (e) => {
      if (e.dataType === 'source' && e.sourceId?.startsWith('fgb-')) {
        if (!loadStart) loadStart = performance.now();
      }
    });

    map.on('idle', () => {
      if (loadStart) {
        const ms = (performance.now() - loadStart).toFixed(0);
        timingEl.textContent = `tiles loaded in ${ms} ms`;
        loadStart = null;
      }
    });

    // ── Visibility toggle ──
    function updateVisibility() {
      loadStart = performance.now();
      for (const d of DATASETS) {
        for (const t of TIERS) {
          const vis = (d === activeDataset && t === activeTier) ? 'visible' : 'none';
          map.setLayoutProperty(`fill-${d}-${t}`, 'visibility', vis);
          map.setLayoutProperty(`line-${d}-${t}`, 'visibility', vis);
        }
      }
    }

    // ── Connector switch ──
    document.querySelectorAll('input[name="dataset"]').forEach((radio) => {
      radio.addEventListener('change', (e) => {
        activeDataset = e.target.value;
        updateVisibility();
      });
    });

    // ── Tier switch ──
    document.querySelectorAll('input[name="tier"]').forEach((radio) => {
      radio.addEventListener('change', (e) => {
        activeTier = e.target.value;
        updateVisibility();
      });
    });
  </script>
</body>
</html>
